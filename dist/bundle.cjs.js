"use strict";var Z=(e,t,n)=>{if(!t.has(e))throw TypeError("Cannot "+n)};var o=(e,t,n)=>(Z(e,t,"read from private field"),n?n.call(e):t.get(e)),a=(e,t,n)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,n)},i=(e,t,n,r)=>(Z(e,t,"write to private field"),r?r.call(e,n):t.set(e,n),n),g=(e,t,n,r)=>({set _(s){i(e,t,s,n)},get _(){return o(e,t,r)}});Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const B="data:application/javascript;base64,c2VsZi5vbm1lc3NhZ2UgPSAoZSkgPT4gewogIGNvbnN0IHsgcGF5bG9hZCB9ID0gZS5kYXRhIHx8IHt9OwogIGNvbnN0IHsgZm4sIGFyZyB9ID0gcGF5bG9hZCB8fCB7fTsKCiAgY29uc3QgbXNnID0gKG0pID0+IG0gfHwgIk5vIEVyciBNc2chIjsKICBjb25zdCBlcnIgPSAoZSkgPT4gKHsKICAgIG1zZzogZSBpbnN0YW5jZW9mIEVycm9yID8gbXNnKGUubWVzc2FnZSkgOiBKU09OLnN0cmluZ2lmeShtc2coZSkpLAogIH0pOwoKICBQcm9taXNlLnJlc29sdmUoYHJldHVybiAoJHtmbn0pKC4uLmFyZ3VtZW50cylgKQogICAgLnRoZW4oRnVuY3Rpb24pCiAgICAudGhlbigoZm4pID0+IGZuKC4uLmFyZykpCiAgICAudGhlbigKICAgICAgKHIpID0+IFtudWxsLCByXSwKICAgICAgKGUpID0+IFtlcnIoZSksIG51bGxdCiAgICApCiAgICAudGhlbihzZWxmLnBvc3RNZXNzYWdlKTsKfTsK",{freeze:S,create:Q}=Object;class b extends Array{}const x=e=>e instanceof b,G=e=>x(e)?e[0]?e:G():S(b.of(e instanceof Error?e:Error(typeof e=="object"?JSON.stringify(e):String(e)),null)),E=e=>x(e)?e:S(b.of(null,e)),K=e=>new Proxy(e,{async apply(...t){try{return E(await Reflect.apply(...t))}catch(n){return G(n)}}}),L=Symbol(),H=(e,t)=>{const n=[];let r=-1,s=-1;for(;++r<e.length;)n.push(e[r]===L?t[++s]:e[r]);for(;++s<t.length;)n.push(t[s]);return n},U=e=>t=>{const n=r=>new Proxy(t,{apply(s,l,C){const y=H(r,C).slice(0,e);return y.length===e&&!y.includes(L)?Reflect.apply(s,l,y):n(y)}});return n([])},D=U(2),_=e=>new Promise(t=>setTimeout(t,e));D((e,t)=>{let n=!0;const r=()=>{n=!1};return{loop:K(async()=>{for(n=!0,await _(e);n;)await t(),await _(e)}),stop:r}});const W=(...e)=>t=>{for(const n of e)t=n(t);return t},F=e=>{let t=null;return new Proxy(e,{async apply(...n){t==null&&(t=Promise.resolve(Reflect.apply(...n)));const r=await t;return t=null,r}})},T=W(F,K),v=()=>{let e,t;const n=new Promise((r,s)=>{[e,t]=[r,s]});return{resolve:e,reject:t,pending:n}};class A{constructor(t){this.next=null,this.value=t}}var u,h,c;class O{constructor(){a(this,u,null);a(this,h,null);a(this,c,0)}size(){return o(this,c)}clear(){i(this,u,null),i(this,h,null),i(this,c,0)}shift(){const t=o(this,u);return o(this,c)&&(i(this,u,t.next),g(this,c)._--),o(this,c)||(i(this,u,null),i(this,h,null)),t==null?void 0:t.value}unshift(t){const n=new A(t);o(this,c)?(n.next=o(this,u),i(this,u,n)):(i(this,u,n),i(this,h,n)),g(this,c)._++}push(t){const n=new A(t);o(this,c)?(o(this,h).next=n,i(this,h,n)):(i(this,u,n),i(this,h,n)),g(this,c)._++}}u=new WeakMap,h=new WeakMap,c=new WeakMap;var I,d,p,m,w;class V{constructor(t){a(this,I,void 0);a(this,d,void 0);a(this,p,void 0);a(this,m,void 0);a(this,w,void 0);i(this,d,0),i(this,p,new O),this.add_task=r=>new Promise((s,l)=>{o(this,p).push({task:r,resolve:s,reject:l}),o(this,w).call(this)}),this.busy=()=>o(this,d)===o(this,I),this.clear=()=>{o(this,p).clear()},i(this,m,()=>!this.busy()&&o(this,p).size()>0),i(this,w,()=>{for(;o(this,m).call(this);){const{task:r,reject:s,resolve:l}=o(this,p).shift();g(this,d)._++,Promise.resolve().then(r).then(l).catch(s).finally(()=>{g(this,d)._--,o(this,w).call(this)})}});const{max_concurrency:n}=t||{};i(this,I,n)}}I=new WeakMap,d=new WeakMap,p=new WeakMap,m=new WeakMap,w=new WeakMap;const N=()=>typeof Deno<"u"&&Deno.version!=null,j=()=>typeof process<"u"&&process.versions!=null,P=()=>typeof window<"u"&&window.document!=null,X=()=>{if(j())return require("os").cpus().length;if(N()||P())return navigator.hardwareConcurrency;throw new Error("Un Support Environment")},Y=()=>{if(N()||P()){const e=new URL(B,typeof document>"u"?require("url").pathToFileURL(__filename).href:document.currentScript&&document.currentScript.src||new URL("bundle.cjs.js",document.baseURI).href);return new Worker(e,{type:"module"})}if(j()){const e=new(require("worker_threads")).Worker(require("path").resolve(__dirname,"./_worker_node.js"));return e.addEventListener=(t,n)=>{e.on(t,n)},e}throw new Error("Un Support Environment")},q=()=>{const e=Y(),t={defer:v()};return e.addEventListener("message",r=>{const[s,l]=r.data||[];s!=null?t.defer.reject(s.msg):t.defer.resolve(l),t.defer=v()}),{worker:e,run:T(async(r,s)=>(e.postMessage({payload:{fn:r.toString(),arg:s}}),await t.defer.pending))}};function J(e){const{max:t=X()-1}=e||{},n=new V({max_concurrency:t}),r=new Map,s=[],l=()=>{for(;r.size<t;){const{size:f}=r;r.set(f,q()),s.push(f)}};return{exec:(f,R)=>(l(),n.add_task(async()=>{const k=s.pop(),z=await r.get(k).run(f,R);return s.push(k),z})),terminate:()=>{for(const{worker:f}of r.values())f.terminate();r.clear(),s.length=0,n.clear()}}}exports.worker_pool=J;
